---
name: Docker Compose Validation

on:
  push:
    branches: [master, main]
    paths:
      - 'docker-compose*.yml'
      - 'docker-compose*.yaml'
      - 'Dockerfile'
      - '.github/workflows/docker-compose.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'docker-compose*.yml'
      - 'docker-compose*.yaml'
      - 'Dockerfile'
      - '.github/workflows/docker-compose.yml'
  workflow_dispatch:

jobs:
  validate-compose:
    name: Validate Docker Compose Stack
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate docker-compose.yml syntax
        run: |
          echo "Validating docker-compose.yml syntax..."
          docker-compose config --quiet
          echo "✅ docker-compose.yml syntax is valid"

      - name: Check docker-compose version
        run: |
          docker-compose version
          docker version

      - name: Validate compose file structure
        run: |
          echo "Checking compose file structure..."
          docker-compose config > /tmp/docker-compose-resolved.yml
          cat /tmp/docker-compose-resolved.yml
          
          # Check for required services
          if ! grep -q "services:" /tmp/docker-compose-resolved.yml; then
            echo "❌ No services defined in docker-compose.yml"
            exit 1
          fi
          echo "✅ Services are defined"

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          ENVIRONMENT=test
          DEBUG=false
          LOG_LEVEL=info
          DATABASE_URL=postgresql://user:password@postgres:5432/appdb
          REDIS_URL=redis://redis:6379/0
          EOF

      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          docker-compose build --no-cache web

      - name: Start Docker Compose stack
        run: |
          echo "Starting Docker Compose stack..."
          docker-compose up -d
          
          # Wait for services to be healthy
          echo "Waiting for services to become healthy..."
          sleep 10

      - name: Check running services
        run: |
          echo "Checking running services..."
          docker-compose ps
          
          # Verify all services are running
          if ! docker-compose ps | grep -q "Up"; then
            echo "❌ Some services failed to start"
            docker-compose logs
            exit 1
          fi
          echo "✅ All services are running"

      - name: Check service health
        run: |
          echo "Checking service health status..."
          
          # Wait for health checks to pass
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            healthy_count=$(docker-compose ps --format json | jq -r 'select(.Health == "healthy") | .Name' | wc -l)
            running_count=$(docker-compose ps --format json | jq -r '.Name' | wc -l)
            
            echo "Attempt $((attempt+1))/$max_attempts: $healthy_count/$running_count services healthy"
            
            if [ "$healthy_count" -ge 3 ]; then
              echo "✅ Services are healthy"
              break
            fi
            
            attempt=$((attempt+1))
            sleep 5
          done

      - name: Test service connectivity
        run: |
          echo "Testing service connectivity..."
          
          # Test PostgreSQL
          docker-compose exec -T postgres pg_isready -U user -d appdb || echo "⚠️ PostgreSQL not ready"
          
          # Test Redis
          docker-compose exec -T redis redis-cli ping || echo "⚠️ Redis not ready"
          
          # Test FastAPI health endpoint (when implemented)
          # curl -f http://localhost:8000/health || echo "⚠️ Web service not responding"
          
          echo "✅ Service connectivity tests completed"

      - name: Display logs on failure
        if: failure()
        run: |
          echo "=========================================="
          echo "Docker Compose Logs"
          echo "=========================================="
          docker-compose logs
          echo "=========================================="
          echo "Container Status"
          echo "=========================================="
          docker-compose ps -a

      - name: Stop and clean up
        if: always()
        run: |
          echo "Stopping Docker Compose stack..."
          docker-compose down -v
          docker-compose ps -a
          echo "✅ Cleanup completed"

  security-scan:
    name: Security Scan Docker Images
    runs-on: ubuntu-latest
    needs: validate-compose

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t fastapi-app:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: fastapi-app:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  docker-compose-lint:
    name: Lint Docker Compose Files
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install docker-compose linter
        run: |
          pip install docker-compose

      - name: Lint docker-compose files
        run: |
          # Validate all docker-compose files
          for file in docker-compose*.yml docker-compose*.yaml; do
            if [ -f "$file" ]; then
              echo "Linting $file..."
              docker-compose -f "$file" config --quiet || exit 1
              echo "✅ $file is valid"
            fi
          done

      - name: Check for best practices
        run: |
          echo "Checking Docker Compose best practices..."
          
          # Check for version specification
          if ! grep -q "version:" docker-compose.yml; then
            echo "⚠️ Warning: No version specified in docker-compose.yml"
          fi
          
          # Check for health checks
          if ! grep -q "healthcheck:" docker-compose.yml; then
            echo "⚠️ Warning: No health checks defined"
          fi
          
          # Check for restart policies
          if ! grep -q "restart:" docker-compose.yml; then
            echo "⚠️ Warning: No restart policies defined"
          fi
          
          # Check for named volumes
          if grep -q "volumes:" docker-compose.yml && ! grep -q "driver:" docker-compose.yml; then
            echo "⚠️ Warning: Volumes defined but no driver specified"
          fi
          
          echo "✅ Best practices check completed"
